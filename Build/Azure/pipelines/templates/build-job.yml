parameters:
  with_nugets: false
  with_examples: false
  with_tests: false
  with_analyzers: false
  with_api_analyzers: false
  with_release: false

jobs:
- job: build_job
  pool:
    vmImage: 'windows-2025'
  displayName: 'Build'
  variables:
    with_analyzers: ${{ parameters.with_analyzers }}
    with_api_analyzers: ${{ parameters.with_api_analyzers }}

  steps:

# use latest SDK explicitly to avoid issues with slow azure updates
  - task: UseDotNet@2
    displayName: 'Use latest .NET SDK'
    inputs:
      packageType: sdk
      version: 9.x

  - task: UseDotNet@2
    displayName: 'Use latest .NET SDK'
    inputs:
      packageType: sdk
      version: 10.x

# tag version numbers appropriately
  - powershell: echo "##vso[task.setvariable variable=assemblyVersion]$(assemblyVersion)-dev.$(Build.BuildId)"
    condition: ne(variables['Build.SourceBranchName'], variables['release_branch'])
    displayName: Update assembly version

  - powershell: echo "##vso[task.setvariable variable=ef3assemblyVersion]$(ef3assemblyVersion)-dev.$(Build.BuildId)"
    condition: ne(variables['Build.SourceBranchName'], variables['release_branch'])
    displayName: Update assembly version

  - powershell: echo "##vso[task.setvariable variable=ef8assemblyVersion]$(ef8assemblyVersion)-dev.$(Build.BuildId)"
    condition: ne(variables['Build.SourceBranchName'], variables['release_branch'])
    displayName: Update assembly version

  - powershell: echo "##vso[task.setvariable variable=ef9assemblyVersion]$(ef9assemblyVersion)-dev.$(Build.BuildId)"
    condition: ne(variables['Build.SourceBranchName'], variables['release_branch'])
    displayName: Update assembly version

  - powershell: echo "##vso[task.setvariable variable=ef10assemblyVersion]$(ef10assemblyVersion)-dev.$(Build.BuildId)"
    condition: ne(variables['Build.SourceBranchName'], variables['release_branch'])
    displayName: Update assembly version

# set version numbers in directory.build.props
  - task: PowerShell@2
    inputs:
      filePath: '$(Build.SourcesDirectory)/Build/SetVersion.ps1'
      workingDirectory: '$(Build.SourcesDirectory)'
      arguments: -path $(Build.SourcesDirectory)/Directory.Build.props -version $(assemblyVersion) -prop Version
    displayName: Update Linq To DB main assembly version

  - task: PowerShell@2
    inputs:
      filePath: '$(Build.SourcesDirectory)/Build/SetVersion.ps1'
      workingDirectory: '$(Build.SourcesDirectory)'
      arguments: -path $(Build.SourcesDirectory)/Directory.Build.props -version $(ef3AssemblyVersion) -prop EF3Version
    displayName: Update EF.Core 3.1 integration assembly version

  - task: PowerShell@2
    inputs:
      filePath: '$(Build.SourcesDirectory)/Build/SetVersion.ps1'
      workingDirectory: '$(Build.SourcesDirectory)'
      arguments: -path $(Build.SourcesDirectory)/Directory.Build.props -version $(ef8AssemblyVersion) -prop EF8Version
    displayName: Update EF.Core 8 integration assembly version

  - task: PowerShell@2
    inputs:
      filePath: '$(Build.SourcesDirectory)/Build/SetVersion.ps1'
      workingDirectory: '$(Build.SourcesDirectory)'
      arguments: -path $(Build.SourcesDirectory)/Directory.Build.props -version $(ef9AssemblyVersion) -prop EF9Version
    displayName: Update EF.Core 9 integration assembly version

  - task: PowerShell@2
    inputs:
      filePath: '$(Build.SourcesDirectory)/Build/SetVersion.ps1'
      workingDirectory: '$(Build.SourcesDirectory)'
      arguments: -path $(Build.SourcesDirectory)/Directory.Build.props -version $(ef10AssemblyVersion) -prop EF10Version
    displayName: Update EF.Core 10 integration assembly version

  - task: DotNetCoreCLI@2
    inputs:
      command: build
      projects: 'Examples/Examples.slnx'
      arguments: '--configuration Debug'
    displayName: Build Examples (verify)
    condition: and(succeeded(), ${{ parameters.with_examples }})

  - task: DotNetCoreCLI@2
    inputs:
      command: build
      projects: $(solution)
      arguments: --configuration $(test_configuration)
    displayName: Build Solution for Tests
    condition: and(succeeded(), ${{ parameters.with_tests }})
    retryCountOnTaskFailure: 1 # https://github.com/dotnet/sdk/issues/44080

  - task: CmdLine@2
    inputs:
      script: |
        ECHO ON
        REM publish main and ef.core tests for all TFMs (without architecture!)
        FOR %%f IN ($(netfx_tfm) net8.0 net9.0 net10.0) DO (
            dotnet publish Tests/Linq/Tests.csproj -f %%f -c $(test_configuration) -o .build/publish/Tests/$(test_configuration)/%%f_x64
            if %errorlevel% neq 0 exit
            )

        dotnet publish Tests/EntityFrameworkCore/Tests.EntityFrameworkCore.EF3.csproj -f net462 -c $(test_configuration) -o .build/publish/EFTests/$(test_configuration)/net462_x64
        if %errorlevel% neq 0 exit

        dotnet publish Tests/EntityFrameworkCore/Tests.EntityFrameworkCore.EF8.csproj -f net8.0 -c $(test_configuration) -o .build/publish/EFTests/$(test_configuration)/net8.0_x64
        if %errorlevel% neq 0 exit
        
        dotnet publish Tests/EntityFrameworkCore/Tests.EntityFrameworkCore.EF9.csproj -f net9.0 -c $(test_configuration) -o .build/publish/EFTests/$(test_configuration)/net9.0_x64
        if %errorlevel% neq 0 exit
        
        dotnet publish Tests/EntityFrameworkCore/Tests.EntityFrameworkCore.EF10.csproj -f net10.0 -c $(test_configuration) -o .build/publish/EFTests/$(test_configuration)/net10.0_x64
        if %errorlevel% neq 0 exit

        REM publish main and ef.core tests for all TFMs for win-x86
        dotnet publish Tests/Linq/Tests.csproj -f net462 -c $(test_configuration) -a x86 -o .build/publish/Tests/$(test_configuration)/net462_x86
        if %errorlevel% neq 0 exit
    
        FOR %%f IN (net8.0 net9.0 net10.0) DO (
            dotnet publish Tests/Linq/Tests.csproj -f %%f -c $(test_configuration) -a x86 /p:DB2STUB=True -o .build/publish/Tests/$(test_configuration)/%%f_x86
            if %errorlevel% neq 0 exit
        )

        dotnet publish Tests/EntityFrameworkCore/Tests.EntityFrameworkCore.EF3.csproj -f net462 -c $(test_configuration) -a x86 -o .build/publish/EFTests/$(test_configuration)/net462_x86
        if %errorlevel% neq 0 exit

        dotnet publish Tests/EntityFrameworkCore/Tests.EntityFrameworkCore.EF8.csproj -f net8.0 -c $(test_configuration) -a x86 -o .build/publish/EFTests/$(test_configuration)/net8.0_x86
        if %errorlevel% neq 0 exit

        dotnet publish Tests/EntityFrameworkCore/Tests.EntityFrameworkCore.EF9.csproj -f net9.0 -c $(test_configuration) -a x86 -o .build/publish/EFTests/$(test_configuration)/net9.0_x86
        if %errorlevel% neq 0 exit
        
        dotnet publish Tests/EntityFrameworkCore/Tests.EntityFrameworkCore.EF10.csproj -f net10.0 -c $(test_configuration) -a x86 -o .build/publish/EFTests/$(test_configuration)/net10.0_x86
        if %errorlevel% neq 0 exit

        mkdir testing
        if %errorlevel% neq 0 exit

        REM prepare test artifacts with binaries and test configs
        FOR %%f IN ($(netfx_tfm) net8.0 net9.0 net10.0) DO (
            FOR %%a IN (x86 x64) DO (
                xcopy /i /s .build\publish\Tests\$(test_configuration)\%%f_%%a testing\%%f\main\%%a
                if %errorlevel% neq 0 exit
                xcopy /i /s .build\publish\EFTests\$(test_configuration)\%%f_%%a testing\%%f\efcore\%%a
                if %errorlevel% neq 0 exit
                copy DataProviders.json testing\%%f\main\%%a
                if %errorlevel% neq 0 exit
                copy DataProviders.json testing\%%f\efcore\%%a
                if %errorlevel% neq 0 exit
            )
        )

        FOR %%c IN (netfx net80 net90 net100) DO (
            xcopy /i Build\$(test_configuration)\%%c testing\configs\%%c
            if %errorlevel% neq 0 exit
        )

        xcopy /i Build\$(test_configuration)\scripts testing\scripts
        if %errorlevel% neq 0 exit

        copy "Data\Create Scripts\Northwind.sql" testing\scripts\northwind.sql
        if %errorlevel% neq 0 exit
    condition: and(succeeded(), ${{ parameters.with_tests }})
    displayName: Build Test Artifacts

  - task: PublishPipelineArtifact@1
    inputs:
      path: '$(Build.SourcesDirectory)/testing/configs'
      artifact: $(artifact_test_configs)
    condition: and(succeeded(), ${{ parameters.with_tests }})
    displayName: Publish Test Configs

  - task: PublishPipelineArtifact@1
    inputs:
      path: '$(Build.SourcesDirectory)/testing/scripts'
      artifact: $(artifact_test_scripts)
    condition: and(succeeded(), ${{ parameters.with_tests }})
    displayName: Publish Test Scripts

  - task: PublishPipelineArtifact@1
    inputs:
      path: '$(Build.SourcesDirectory)/testing/net462'
      artifact: $(artifact_test_netfx_binaries)
    condition: and(succeeded(), ${{ parameters.with_tests }})
    displayName: Publish NETFX Test Binaries

  - task: PublishPipelineArtifact@1
    inputs:
      path: '$(Build.SourcesDirectory)/testing/net8.0'
      artifact: $(artifact_test_net80_binaries)
    condition: and(succeeded(), ${{ parameters.with_tests }})
    displayName: Publish NET 8.0 Test Binaries

  - task: PublishPipelineArtifact@1
    inputs:
      path: '$(Build.SourcesDirectory)/testing/net9.0'
      artifact: $(artifact_test_net90_binaries)
    condition: and(succeeded(), ${{ parameters.with_tests }})
    displayName: Publish NET 9.0 Test Binaries

  - task: PublishPipelineArtifact@1
    inputs:
      path: '$(Build.SourcesDirectory)/testing/net10.0'
      artifact: $(artifact_test_net100_binaries)
    condition: and(succeeded(), ${{ parameters.with_tests }})
    displayName: Publish NET 10.0 Test Binaries

# we shouldn't care about CI cleanup in general, but it's about limited disk space we need for next tasks
  - task: CmdLine@2
    inputs:
      script: |
        ECHO ON
        RD $(Build.SourcesDirectory)\testing /S /Q
        RD $(Build.SourcesDirectory)\.build /S /Q
    condition: and(succeeded(), ${{ parameters.with_tests }})
    displayName: Cleanup Test Artifacts

  - task: DotNetCoreCLI@2
    inputs:
      command: build
      projects: $(solution)
      arguments: -property:RunAnalyzersDuringBuild=${{ variables['with_analyzers'] }} -property:RunApiAnalyzersDuringBuild=${{ variables['with_api_analyzers'] }} --configuration $(release_configuration)
    displayName: Build Solution for Nuget
    condition: and(succeeded(), ${{ parameters.with_nugets }})

  - task: DotNetCoreCLI@2
    inputs:
      command: pack
      projects: $(solution)
      arguments: -property:RunAnalyzersDuringBuild=${{ variables['with_analyzers'] }} -property:RunApiAnalyzersDuringBuild=${{ variables['with_api_analyzers'] }} --configuration $(release_configuration)
    displayName: Pack Solution for Nuget
    condition: and(succeeded(), ${{ parameters.with_nugets }})

  - task: PublishPipelineArtifact@1
    inputs:
      path: '$(Build.SourcesDirectory)/.build/package/release'
      artifact: '$(artifact_nugets)'
    displayName: Publish linq2db nugets
    condition: and(succeeded(), ${{ parameters.with_nugets }})

  - task: PublishBuildArtifacts@1
    inputs:
      pathToPublish: '$(Build.SourcesDirectory)/.build/lpx'
      artifactName: '$(artifact_linq2db_linqpad_lpx)'
    displayName: Publish LPX to artifacts
    condition: and(succeeded(), ${{ parameters.with_nugets }})

  - task: PowerShell@2
    inputs:
      targetType: 'inline'
      script: |
        $relnotesVersion = '$(packageVersion)' -replace '\.',''
        Write-Host "Create release v$(packageVersion) draft"
        $output = gh release create v$(packageVersion) "$(Build.SourcesDirectory)/.build/lpx/linq2db.LINQPad.lpx" "$(Build.SourcesDirectory)/.build/lpx/linq2db.LINQPad.lpx6" --draft --fail-on-no-commits --generate-notes --latest --notes "[Release notes](https://github.com/linq2db/linq2db/wiki/Releases-and-Roadmap#release-$relnotesVersion) [Nugets](https://www.nuget.org/profiles/LinqToDB)" --title "Release $(packageVersion)"
        if ($LASTEXITCODE -ne 0) {
            Write-Host "Command failed. Error code ${LASTEXITCODE}, output: ${output}"
            exit 1
        }
      workingDirectory: '$(System.DefaultWorkingDirectory)'
    displayName: Create Release Draft
    condition: and(succeeded(), ${{ parameters.with_release }})
    env:
      GITHUB_TOKEN: $(RELEASES_GH_PAT)
