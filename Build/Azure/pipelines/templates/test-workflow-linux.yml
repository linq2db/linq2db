parameters:
  with_baselines: false

steps:
- checkout: none

- task: UseDotNet@2
  displayName: 'Install .net core 3.1'
  inputs:
    packageType: sdk
    version: 3.1.x
  condition: eq('variables.netcore31', true)

- task: UseDotNet@2
  displayName: 'Install .net 5'
  inputs:
    packageType: sdk
    version: 5.x
  condition: eq('variables.net50', true)

- task: UseDotNet@2
  displayName: 'Install .net 6'
  inputs:
    packageType: sdk
    version: 6.x

- task: CmdLine@2
  inputs:
    script: 'git clone https://$(BASELINES_GH_PAT)@github.com/linq2db/linq2db.baselines.git baselines && cd baselines && git checkout -b $(baselines_branch) origin/$(baselines_branch) && cd ..'
    workingDirectory: '$(System.DefaultWorkingDirectory)'
  displayName: Checkout test baselines
  condition: and(variables.title, ${{ parameters.with_baselines }})

- task: DownloadPipelineArtifact@2
  inputs:
    artifactName: netcore31_tests
    targetPath: '$(System.DefaultWorkingDirectory)/netcore31'
  condition: variables.netcore31

- task: DownloadPipelineArtifact@2
  inputs:
    artifactName: net50_tests
    targetPath: '$(System.DefaultWorkingDirectory)/net50'
  condition: variables.net50

- task: DownloadPipelineArtifact@2
  inputs:
    artifactName: net60_tests
    targetPath: '$(System.DefaultWorkingDirectory)/net60'
  condition: variables.net60

- task: CmdLine@2
  inputs:
    script: 'cp $(System.DefaultWorkingDirectory)/netcore31/configs/$(config).json netcore31/UserDataProviders.json'
    workingDirectory: '$(System.DefaultWorkingDirectory)'
  displayName: Copy test config
  condition: variables.netcore31

- task: CmdLine@2
  inputs:
    script: 'cp $(System.DefaultWorkingDirectory)/net50/configs/$(config).json net50/UserDataProviders.json'
    workingDirectory: '$(System.DefaultWorkingDirectory)'
  displayName: Copy test config
  condition: variables.net50

- task: CmdLine@2
  inputs:
    script: 'cp $(System.DefaultWorkingDirectory)/net60/configs/$(config).json net60/UserDataProviders.json'
    workingDirectory: '$(System.DefaultWorkingDirectory)'
  displayName: Copy test config
  condition: variables.net60

- task: NuGet@0
  displayName: Install nugets
  inputs:
    command: 'install'
    arguments: '$(nuget) -ExcludeVersion'
    workingDirectory: '$(System.DefaultWorkingDirectory)/netcore31/scripts'
  condition: and(variables.title, variables.nuget, variables.netcore31)

- task: NuGet@0
  displayName: Install nugets
  inputs:
    command: 'install'
    arguments: '$(nuget) -ExcludeVersion'
    workingDirectory: '$(System.DefaultWorkingDirectory)/net50/scripts'
  condition: and(variables.title, variables.nuget, variables.net50)

- task: NuGet@0
  displayName: Install nugets
  inputs:
    command: 'install'
    arguments: '$(nuget) -ExcludeVersion'
    workingDirectory: '$(System.DefaultWorkingDirectory)/net60/scripts'
  condition: and(variables.title, variables.nuget, variables.net60)

- task: CmdLine@2
  inputs:
    script: 'chmod +x $(script)'
    workingDirectory: '$(System.DefaultWorkingDirectory)/netcore31/scripts'
  condition: and(variables.title, variables.script, variables.netcore31)
  displayName: Mark script as executable

- task: CmdLine@2
  inputs:
    script: 'chmod +x $(script)'
    workingDirectory: '$(System.DefaultWorkingDirectory)/net50/scripts'
  condition: and(variables.title, variables.script, variables.net50)
  displayName: Mark script as executable

- task: CmdLine@2
  inputs:
    script: 'chmod +x $(script)'
    workingDirectory: '$(System.DefaultWorkingDirectory)/net60/scripts'
  condition: and(variables.title, variables.script, variables.net60)
  displayName: Mark script as executable

- task: CmdLine@2
  inputs:
    script: '$(System.DefaultWorkingDirectory)/netcore31/scripts/$(script)'
    workingDirectory: '$(System.DefaultWorkingDirectory)/netcore31'
  condition: and(variables.title, variables.script, variables.netcore31, not(or(variables.net50, variables.net60)))
  displayName: Setup tests

- task: CmdLine@2
  inputs:
    script: '$(System.DefaultWorkingDirectory)/net50/scripts/$(script)'
    workingDirectory: '$(System.DefaultWorkingDirectory)/net50'
  condition: and(variables.title, variables.script, variables.net50, not(variables.net60))
  displayName: Setup tests

- task: CmdLine@2
  inputs:
    script: '$(System.DefaultWorkingDirectory)/net60/scripts/$(script)'
    workingDirectory: '$(System.DefaultWorkingDirectory)/net60'
  condition: and(variables.title, variables.script, variables.net60)
  displayName: Setup tests

- script: dotnet test ./netcore31/linq2db.Tests.dll --filter "TestCategory != SkipCI" -f netcoreapp31 -l trx $(extra)
  condition: and(variables.title, variables.netcore31, succeeded())
  displayName: 'Execute tests: $(title)'

- script: dotnet test ./net50/linq2db.Tests.dll --filter "TestCategory != SkipCI" -f net50 -l trx $(extra)
  condition: and(variables.title, variables.net50, succeeded())
  displayName: 'Execute tests: $(title)'

- script: dotnet test ./net60/linq2db.Tests.dll --filter "TestCategory != SkipCI" -f net60 -l trx $(extra)
  condition: and(variables.title, variables.net60, succeeded())
  displayName: 'Execute tests: $(title)'

- task: PublishTestResults@2
  condition: and(variables.title, succeededOrFailed())
  inputs:
    testRunner: VsTest
    testResultsFiles: '**/*.trx'
    testRunTitle: 'Linux / $(title)'

- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      Write-Host "Add baselines changes to commit (index)"
      $output = git add -A
      if ($LASTEXITCODE -ne 0) {
          Write-Host "Failed to add baselines changes. Error code ${LASTEXITCODE}, output: ${output}"
          exit 1
      }
      Write-Host "Create commit"
      $output = git commit -m "[Linux / $(title)] baselines"
      if ($output -match "nothing to commit") {
          Write-Host "No baselines changes detected"
          exit 0
      }
      if ($LASTEXITCODE -ne 0) {
          Write-Host "Failed to create commit. Error code ${LASTEXITCODE}, output: ${output}"
          exit 1
      }
      $rebaseAttempts = 10
      do {
          Write-Host "Pull with rebase"
          $output = git pull --rebase
          if ($LASTEXITCODE -ne 0) {
              Write-Host "Failed to rebase. Error code ${LASTEXITCODE}, output: ${output}"
              exit 1
          }
          Write-Host "Push baselines to server"
          $output = git push https://$(BASELINES_GH_PAT)@github.com/linq2db/linq2db.baselines.git $(baselines_branch)
          if ($LASTEXITCODE -ne 0) {
              Write-Host "Failed to push baselines. Error code ${LASTEXITCODE}, output: ${output}"
          } else {
              exit 0
          }
          $rebaseAttempts = $rebaseAttempts - 1
      } while ($rebaseAttempts -gt 0)
      Write-Host "Failed to push baselines"
      exit 1
    workingDirectory: '$(System.DefaultWorkingDirectory)/baselines'
  displayName: Commit test baselines
  condition: and(variables.title, succeeded(), ${{ parameters.with_baselines }})
  env:
    GITHUB_TOKEN: $(BASELINES_GH_PAT)
    EMAIL: azp@linq2db.com
    GIT_AUTHOR_NAME: Azure Pipelines Bot
    GIT_COMMITTER_NAME: Azure Pipelines Bot

# dunno why, but it is not needed for now for linux images
#    - task: Docker@2
#      displayName: Auth on hub.docker.com
#      inputs:
#        command: login
#        containerRegistry: dockerhub
#      condition: and(variables.title, eq(variables.docker_login, 'true'))
