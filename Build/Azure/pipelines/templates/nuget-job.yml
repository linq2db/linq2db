parameters:
  release: false

jobs:
- job: build_nugets_job
  pool:
    vmImage: 'windows-2025'
  displayName: 'Nugets Generation'
  dependsOn: build_job
  condition: succeeded()

  steps:

  - task: DownloadPipelineArtifact@2
    displayName: Download LinqToDB files
    inputs:
      artifactName: '$(artifact_nugets)'
      targetPath: '$(Build.SourcesDirectory)/.build/package/release'

  - task: NuGetCommand@2
    inputs:
      command: 'push'
      packagesToPush: '$(Build.SourcesDirectory)/.build/nugets/*.nupkg'
      nuGetFeedType: 'internal'
      publishVstsFeed: '0dcc414b-ea54-451e-a54f-d63f05367c4b/967a4107-9788-41a4-9f6d-a2318aab1410'
    displayName: Publish to Azure Artifacts feed
    condition: and(succeeded(), eq(variables['Build.SourceBranchName'], variables['master_branch']))

  - task: NuGetCommand@2
    inputs:
      command: 'push'
      packagesToPush: '$(Build.SourcesDirectory)/.build/nugets/*.nupkg'
      nuGetFeedType: 'external'
      publishFeedCredentials: 'linq2db nuget.org feed'
    displayName: Publish to Nuget.org
    condition: and(succeeded(), eq(variables['Build.SourceBranchName'], variables['release_branch']))

  - task: PowerShell@2
    inputs:
      targetType: 'inline'
      script: |
        $relnotesVersion = '$(packageVersion)' -replace '\.',''
        Write-Host "Add linqpad nuget to release v$(packageVersion) draft"
        $output = gh release upload v$(packageVersion) "$(Build.SourcesDirectory)/.build/nugets/linq2db.LINQPad.$(packageVersion).nupkg"
        if ($LASTEXITCODE -ne 0) {
            Write-Host "Command failed. Error code ${LASTEXITCODE}, output: ${output}"
            exit 1
        }
      workingDirectory: '$(System.DefaultWorkingDirectory)'
    displayName: Upload LINQPad nuget to Release Draft
    condition: and(succeeded(), ${{ parameters.release }})
    env:
      GITHUB_TOKEN: $(RELEASES_GH_PAT)
